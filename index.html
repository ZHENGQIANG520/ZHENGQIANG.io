<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å•†å®¶ç‰ˆ - å¥åº·è¯ç®¡ç†ï¼ˆæœ€ç»ˆç‰ˆï¼‰</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400,500,700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx@1.8.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:"Noto Sans SC",sans-serif;}
:root{
  --c1:#1677ff;--c2:#36d399;--c3:#ff7d00;--c4:#f53f3f;
  --bg:#f5f7fa;--card:#fff;--bd:#e5eeb;
  --shadow:0 4px 20px rgba(0,0,0,.06);
}
body{background:var(--bg);color:#1d2d44;line-height:1.6;}
.container{width:100%;max-width:1200px;margin:0 auto;padding:0 12px;}
.btn{padding:10px 14px;border-radius:8px;border:0;cursor:pointer;transition:.2s;font-size:14px;}
.btn-primary{background:var(--c1);color:#fff;box-shadow:0 2px 8px rgba(22,119,255,.2);}
.btn-outline{border:1px solid var(--c1);color:var(--c1);background:#fff;}
.btn-success{background:var(--c2);color:#fff;}
.btn-danger{background:var(--c4);color:#fff;}
.section{padding:12px 0;}
.section-title{font-size:18px;margin-bottom:12px;font-weight:600;}
.card{background:var(--card);border-radius:12px;padding:16px;box-shadow:var(--shadow);}
.label{font-size:13px;color:#4e5669;margin-bottom:6px;}
.form-item{margin-bottom:10px;}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--bd);border-radius:8px;font-size:14px;}
.tag{padding:3px 6px;border-radius:4px;font-size:12px;}
.tag-success{background:#e8fff3;color:#129966;}
.tag-wait{background:#fff7e8;color:#b99000;}
.tag-expire{background:#ffe8e8;color:#cc3333;}
.grid{display:grid;gap:12px;}
.grid-2{grid-template-columns:repeat(2,1fr);}
table{width:100%;border-collapse:collapse;font-size:14px;}
th,td{padding:10px;text-align:left;border-bottom:1px solid var(--bd);}
thead tr{background:#e8f3ff;}

/* å¥åº·è¯å¡ç‰‡ï¼ˆåœ†è§’é•¿æ–¹å½¢ + è‡ªé€‚åº”ï¼‰ */
.cert-card{
  width:90%;
  max-width:420px;
  min-height:280px;
  background:#fff;
  border:1px solid #ddd;
  border-radius:20px;
  padding:20px;
  position:relative;
  margin:20px auto;
  font-size:14px;
  box-shadow:0 4px 15px rgba(0,0,0,.1);
  box-sizing:border-box;
  overflow:hidden;
}
.cert-title{
  text-align:center;
  font-weight:700;
  font-size:18px;
  margin-bottom:16px;
}
.cert-grid{
  display:grid;
  grid-template-columns:auto 1fr;
  gap:8px 12px;
  font-size:14px;
}
.cert-photo{
  position:absolute;
  right:20px;top:20px;
  width:80px;height:100px;
  object-fit:cover;
  border-radius:8px;
}
.cert-qr{
  position:absolute;
  right:20px;bottom:20px;
  width:80px;height:80px;
  border-radius:8px;
}
/* å…¬ç« ä½ç½®ï¼šå‘è¯æœºæ„å’ŒçŠ¶æ€æ ä¸­é—´ */
.cert-stamp{
  position:absolute;
  left:50%;
  top:55%;
  transform:translate(-50%,-50%);
  width:80px;height:80px;
  border:2px solid #c0392b;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#c0392b;
  font-weight:700;
  font-size:10px;
  text-align:center;
  flex-direction:column;
  line-height:1.3;
  padding:6px;
  background:rgba(255,255,255,0.9);
}

/* äºŒç»´ç ç›’å­ */
.qr-box{width:260px;height:260px;margin:10px auto;border:1px solid #eee;display:flex;align-items:center;justify-content:center;}
.qr-actions{text-align:center;margin-top:8px;}

/* ä½“æ£€æŠ¥å‘Šé¡µé¢ä¸­é—´ï¼šå¯è°ƒèŠ‚å¤§å°ä¸Šä¼ æ¡† */
.report-upload-area{
  width:320px;height:220px;
  margin:20px auto;
  border:2px dashed #999;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  background:#f9f9f9;
  resize:both;
  overflow:auto;
  padding:10px;
}
.report-upload-area input{
  margin-bottom:10px;
}
.report-upload-area img{
  max-width:100%;
  max-height:160px;
  object-fit:contain;
  border-radius:6px;
}

/* æ‰“å°æ ·å¼ */
@media print{
  body{background:#fff;}
  .no-print{display:none!important;}
  .cert-card{page-break-after:always;border:none;box-shadow:none;}
}

/* åŠŸèƒ½åŒºç‹¬ç«‹ + è‡ªé€‚åº” */
.page{display:none;}
.page.active{display:block;}
.tab-bar{display:flex;gap:8px;background:#fff;padding:10px;border-radius:12px;margin-bottom:12px;flex-wrap:wrap;}
.tab-btn{padding:8px 12px;border-radius:8px;border:0;background:#f5f7fa;cursor:pointer;flex:1;min-width:100px;text-align:center;}
.tab-btn.active{background:var(--c1);color:#fff;}

/* å°å±å¹•é€‚é… */
@media(max-width:768px){
  .grid-2{grid-template-columns:1fr;}
  .tab-btn{min-width:80px;font-size:12px;padding:6px 8px;}
  .cert-card{width:95%;padding:16px;}
  .cert-photo{width:70px;height:85px;}
  .cert-qr{width:70px;height:70px;}
  .report-upload-area{width:90%;height:180px;}
}
</style>
</head>
<body>

<div class="container">
  <!-- é¡¶éƒ¨æ ‡ç­¾æ  -->
  <div class="tab-bar no-print">
    <button class="tab-btn active" onclick="switchPage('page1')">å‘˜å·¥ç®¡ç†</button>
    <button class="tab-btn" onclick="switchPage('page2')">å¥åº·è¯å¡ç‰‡</button>
    <button class="tab-btn" onclick="switchPage('page3')">ä½“æ£€æŠ¥å‘Š</button>
    <button class="tab-btn" onclick="switchPage('page4')">äºŒç»´ç ç”Ÿæˆå™¨</button>
  </div>

  <!-- ====================== åŠŸèƒ½åŒº1ï¼šå‘˜å·¥ç®¡ç† ====================== -->
  <div id="page1" class="page active">
    <div class="card">
      <div class="section-title">ğŸ‘¥ å‘˜å·¥ç®¡ç†</div>
      <div style="display:flex;gap:10px;margin-bottom:12px;flex-wrap:wrap;">
        <button class="btn btn-primary" onclick="openStaff()">æ–°å¢å‘˜å·¥</button>
        <button class="btn btn-success" onclick="exportStaff()">å¯¼å‡ºExcel</button>
        <button class="btn btn-outline" onclick="importStaff()">å¯¼å…¥Excel</button>
      </div>
      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>å§“å</th><th>æ€§åˆ«</th><th>å²æ•°</th><th>èº«ä»½è¯å·</th><th>ç±»åˆ«</th><th>ä½“æ£€ç¼–ç </th><th>çŠ¶æ€</th><th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="staffTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ====================== åŠŸèƒ½åŒº2ï¼šå¥åº·è¯å¡ç‰‡ï¼ˆå·²æ”¹ï¼šå…¬ç« ä½ç½® + å­—æ®µåï¼‰ ====================== -->
  <div id="page2" class="page">
    <div class="card no-print">
      <div class="section-title">ğŸªª å¥åº·è¯å¡ç‰‡</div>
      
      <div class="form-item">
        <label class="label">é€‰æ‹©å‘˜å·¥</label>
        <select id="certSelect" onchange="loadCert()"></select>
      </div>

      <div class="form-item">
        <label class="label">ä¸Šä¼ è‡ªå®šä¹‰äºŒç»´ç ï¼ˆå¯é€‰ï¼‰</label>
        <input type="file" id="uploadCertQR" accept="image/*" onchange="uploadCertQR()">
      </div>

      <div style="text-align:center;margin-top:10px;">
        <button class="btn btn-primary" onclick="window.print()">æ‰“å°å¥åº·è¯</button>
      </div>
    </div>

    <div id="certContainer" style="margin-top:10px;"></div>
  </div>

  <!-- ====================== åŠŸèƒ½åŒº3ï¼šä½“æ£€æŠ¥å‘Šï¼ˆä¸­é—´å¯è°ƒèŠ‚ä¸Šä¼ æ¡†ï¼‰ ====================== -->
  <div id="page3" class="page">
    <div class="card">
      <div class="section-title">ğŸ“„ ä½“æ£€æŠ¥å‘Š</div>
      <div class="form-item">
        <label class="label">é€‰æ‹©å‘˜å·¥</label>
        <select id="reportSelect" onchange="showReport()"></select>
      </div>
      <div class="grid grid-2" style="margin-top:12px;">
        <div class="form-item"><label class="label">å§“å</label><input id="rName" readonly></div>
        <div class="form-item"><label class="label">æ€§åˆ«</label><input id="rGender" readonly></div>
        <div class="form-item"><label class="label">å²æ•°</label><input id="rAge" readonly></div>
        <div class="form-item"><label class="label">èº«ä»½è¯å·</label><input id="rId" readonly></div>
        <div class="form-item"><label class="label">ç±»åˆ«</label><input id="rType" readonly></div>
        <div class="form-item">
          <label class="label">å‘è¯æœºæ„</label>
          <select id="rOrg">
            <option value="æ¸ä¸­åŒºä¸ƒæ˜Ÿå²—è¡—é“ç¤¾åŒºå«ç”ŸæœåŠ¡ä¸­å¿ƒ">æ¸ä¸­åŒºä¸ƒæ˜Ÿå²—è¡—é“ç¤¾åŒºå«ç”ŸæœåŠ¡ä¸­å¿ƒ</option>
            <option value="æ¸ä¸­åŒºæœå¤©é—¨è¡—é“ç¤¾åŒºå«ç”ŸæœåŠ¡ä¸­å¿ƒ">æ¸ä¸­åŒºæœå¤©é—¨è¡—é“ç¤¾åŒºå«ç”ŸæœåŠ¡ä¸­å¿ƒ</option>
          </select>
        </div>
        <div class="form-item"><label class="label">ä½“æ£€æ—¥æœŸ</label><input id="rDate" readonly></div>
        <div class="form-item"><label class="label">çŠ¶æ€</label><input id="rStatus" readonly></div>
        <div class="form-item"><label class="label">ä½“æ£€ç¼–ç </label><input id="rCode" readonly></div>
      </div>

      <!-- ä½“æ£€æŠ¥å‘Šä¸­é—´ï¼šå¯è°ƒèŠ‚å¤§å°ä¸Šä¼ æ¡† -->
      <div class="report-upload-area">
        <input type="file" id="reportCenterUpload" accept="image/*" onchange="uploadReportCenter()">
        <div>æ‹–æ‹½å³ä¸‹è§’å¯è°ƒèŠ‚å¤§å°</div>
        <img id="reportCenterPreview" style="display:none;">
      </div>

      <div style="text-align:center;margin-top:10px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
        <button class="btn btn-primary" onclick="editReport()">ç¼–è¾‘æŠ¥å‘Š</button>
        <button class="btn btn-success" onclick="genCertLinkQR()">ç”Ÿæˆå¥åº·è¯é“¾æ¥äºŒç»´ç </button>
      </div>
      <div id="reportQRBox" class="qr-box" style="margin-top:10px;"><div style="color:#999">äºŒç»´ç åŒºåŸŸ</div></div>
      <div style="text-align:center;margin-top:8px;">
        <button class="btn btn-outline" onclick="downloadReportQR()" style="display:none;" id="downloadReportQRBtn">ä¸‹è½½äºŒç»´ç </button>
      </div>
    </div>
  </div>

  <!-- ====================== åŠŸèƒ½åŒº4ï¼šäºŒç»´ç ç”Ÿæˆå™¨ ====================== -->
  <div id="page4" class="page">
    <div class="card">
      <div class="section-title">ğŸ“± äºŒç»´ç ç”Ÿæˆå™¨</div>
      <div class="form-item">
        <label class="label">é€‰æ‹©å‘˜å·¥ï¼ˆè‡ªåŠ¨ç”Ÿæˆå¥åº·è¯é“¾æ¥ï¼‰</label>
        <select id="qrStaffSelect"></select>
      </div>
      <div class="form-item">
        <label class="label">æˆ–ä¸Šä¼ å¥åº·è¯å›¾ç‰‡ç”ŸæˆäºŒç»´ç </label>
        <input type="file" id="certUpload" accept="image/*">
      </div>
      <div class="form-item">
        <label class="label">æˆ–æ‰‹åŠ¨è¾“å…¥å†…å®¹</label>
        <textarea id="qrContent" rows="3" placeholder="è¯·è¾“å…¥è¦ç”ŸæˆäºŒç»´ç çš„å†…å®¹"></textarea>
      </div>
      <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;">
        <button class="btn btn-primary" onclick="genStaffCertQR()">ç”Ÿæˆå‘˜å·¥å¥åº·è¯äºŒç»´ç </button>
        <button class="btn btn-primary" onclick="genUploadCertQR()">ç”Ÿæˆä¸Šä¼ å›¾ç‰‡äºŒç»´ç </button>
        <button class="btn btn-primary" onclick="genCustomQR()">ç”Ÿæˆè‡ªå®šä¹‰äºŒç»´ç </button>
      </div>
      <div class="qr-box" id="qrBox" style="margin-top:10px;"><div style="color:#999">ç‚¹å‡»ç”Ÿæˆ</div></div>
      <div class="qr-actions" style="margin-top:8px;">
        <button class="btn btn-outline" onclick="downloadQR()">ä¸‹è½½äºŒç»´ç </button>
      </div>
    </div>
  </div>
</div>

<!-- å‘˜å·¥ç¼–è¾‘å¼¹çª— -->
<div class="modal no-print" id="staffModal" style="position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:100;">
  <div class="card" style="width:min(600px,96%);">
    <div class="section-title" id="staffTitle">æ–°å¢å‘˜å·¥</div>
    <div class="grid grid-2">
      <div class="form-item">
        <label class="label">ç…§ç‰‡</label>
        <div id="photoPreview" style="width:100px;height:130px;border:1px dashed #ccc;display:flex;align-items:center;justify-content:center;color:#999;cursor:pointer;">ç‚¹å‡»ä¸Šä¼ </div>
        <input type="file" id="photoUpload" accept="image/*" style="display:none" onchange="previewPhoto()">
      </div>
      <div class="form-item"><label class="label">å§“å</label><input id="sName"></div>
      <div class="form-item"><label class="label">æ€§åˆ«</label><select id="sGender"><option>ç”·</option><option>å¥³</option></select></div>
      <div class="form-item"><label class="label">å²æ•°</label><input id="sAge"></div>
      <div class="form-item"><label class="label">èº«ä»½è¯å·</label><input id="sId"></div>
      <div class="form-item"><label class="label">ç±»åˆ«</label><select id="sType"><option>é¤é¥®æœåŠ¡</option><option>é£Ÿå“ç»è¥</option><option>å…¬å…±åœºæ‰€</option></select></div>
      <div class="form-item">
        <label class="label">å‘è¯æœºæ„</label>
        <select id="sOrg">
          <option value="æ¸ä¸­åŒºä¸ƒæ˜Ÿå²—è¡—é“ç¤¾åŒºå«ç”ŸæœåŠ¡ä¸­å¿ƒ">æ¸ä¸­åŒºä¸ƒæ˜Ÿå²—è¡—é“ç¤¾åŒºå«ç”ŸæœåŠ¡ä¸­å¿ƒ</option>
          <option value="æ¸ä¸­åŒºæœå¤©é—¨è¡—é“ç¤¾åŒºå«ç”ŸæœåŠ¡ä¸­å¿ƒ">æ¸ä¸­åŒºæœå¤©é—¨è¡—é“ç¤¾åŒºå«ç”ŸæœåŠ¡ä¸­å¿ƒ</option>
        </select>
      </div>
      <div class="form-item"><label class="label">ä½“æ£€æ—¥æœŸ</label><input type="date" id="sDate"></div>
      <div class="form-item"><label class="label">çŠ¶æ€</label><select id="sStatus"><option>æœ‰æ•ˆ</option><option>å³å°†åˆ°æœŸ</option><option>å·²è¿‡æœŸ</option></select></div>
      <div class="form-item"><label class="label">ä½“æ£€ç¼–ç </label><input id="sCode"></div>
    </div>
    <div style="display:flex;gap:10px;margin-top:10px;">
      <button class="btn btn-primary" onclick="saveStaff()">ä¿å­˜</button>
      <button class="btn btn-outline" onclick="closeModal()">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<script>
let staff = JSON.parse(localStorage.getItem('healthStaff')) || [];
let curIdx = -1;
let curPhoto = '';
let qrCanvas = null;
let reportQRCanvas = null;
let uploadedQR = '';

// åˆ‡æ¢åŠŸèƒ½åŒº
function switchPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// åˆå§‹åŒ–
window.onload = () => {
  renderStaff();
  initCertSelect();
  initReportSelect();
  initQRStaffSelect();
};

// ====================== å‘˜å·¥ç®¡ç† ======================
function renderStaff() {
  let t = document.getElementById('staffTable');
  t.innerHTML = '';
  staff.forEach((s, i) => {
    t.innerHTML += `
      <tr>
        <td>${s.name}</td>
        <td>${s.gender}</td>
        <td>${s.age}</td>
        <td>${s.id}</td>
        <td>${s.type}</td>
        <td>${s.code}</td>
        <td><span class="tag ${s.status==='æœ‰æ•ˆ'?'tag-success':s.status==='å³å°†åˆ°æœŸ'?'tag-wait':'tag-expire'}">${s.status}</span></td>
        <td>
          <button class="btn btn-text" onclick="editStaff(${i})" style="padding:4px 8px;font-size:12px">ç¼–è¾‘</button>
          <button class="btn btn-text" onclick="delStaff(${i})" style="padding:4px 8px;font-size:12px">åˆ é™¤</button>
        </td>
      </tr>
    `;
  });
}

// ====================== å¥åº·è¯å¡ç‰‡ï¼ˆå…¬ç« åœ¨ä¸­é—´ + å­—æ®µæ”¹ä¸ºä½“æ£€æœºæ„ï¼‰ ======================
function initCertSelect() {
  let sel = document.getElementById('certSelect');
  sel.innerHTML = '<option value="">è¯·é€‰æ‹©å‘˜å·¥</option>';
  staff.forEach((s, i) => {
    sel.innerHTML += `<option value="${i}">${s.name} - ${s.code}</option>`;
  });
}

function loadCert() {
  let i = document.getElementById('certSelect').value;
  if (i === '') return;
  let s = staff[i];
  let certUrl = window.location.origin + window.location.pathname + '?cert=' + encodeURIComponent(s.id);
  let stampText = s.org || 'æ¸ä¸­åŒºä¸ƒæ˜Ÿå²—è¡—é“ç¤¾åŒºå«ç”ŸæœåŠ¡ä¸­å¿ƒ';
  
  let card = `
    <div class="cert-card">
      <div class="cert-title">ä»ä¸šäººå‘˜å¥åº·è¯æ˜</div>
      <div class="cert-grid">
        <div>å§“å</div><div>${s.name}</div>
        <div>æ€§åˆ«</div><div>${s.gender}</div>
        <div>å²æ•°</div><div>${s.age}</div>
        <div>èº«ä»½è¯</div><div>${s.id}</div>
        <div>ç±»åˆ«</div><div>${s.type}</div>
        <div>ä½“æ£€æœºæ„</div><div>${s.org}</div>
        <div>ä½“æ£€æ—¥æœŸ</div><div>${s.date}</div>
        <div>çŠ¶æ€</div><div>${s.status}</div>
        <div>ä½“æ£€ç¼–ç </div><div>${s.code}</div>
      </div>
      ${s.photo ? `<img src="${s.photo}" class="cert-photo">` : ''}
      <img class="cert-qr" id="cardQR" src="${uploadedQR || ''}">
      <div class="cert-stamp">${stampText}</div>
    </div>
  `;
  document.getElementById('certContainer').innerHTML = card;

  if (!uploadedQR) {
    let qrImg = document.getElementById('cardQR');
    QRCode.toDataURL(certUrl, { width: 180 }, (err, url) => {
      if (!err) qrImg.src = url;
    });
  }
}

function uploadCertQR() {
  let file = document.getElementById('uploadCertQR').files[0];
  if (!file) return;
  let reader = new FileReader();
  reader.onload = e => {
    uploadedQR = e.target.result;
    loadCert();
  };
  reader.readAsDataURL(file);
}

// ====================== ä½“æ£€æŠ¥å‘Šï¼ˆä¸­é—´å¯è°ƒèŠ‚ä¸Šä¼ æ¡†ï¼‰ ======================
function initReportSelect() {
  let sel = document.getElementById('reportSelect');
  sel.innerHTML = '<option value="">è¯·é€‰æ‹©å‘˜å·¥</option>';
  staff.forEach((s, i) => {
    sel.innerHTML += `<option value="${i}">${s.name} - ${s.code}</option>`;
  });
}

function showReport() {
  let i = document.getElementById('reportSelect').value;
  if (i === '') return;
  let s = staff[i];
  document.getElementById('rName').value = s.name;
  document.getElementById('rGender').value = s.gender;
  document.getElementById('rAge').value = s.age;
  document.getElementById('rId').value = s.id;
  document.getElementById('rType').value = s.type;
  document.getElementById('rOrg').value = s.org || 'æ¸ä¸­åŒºä¸ƒæ˜Ÿå²—è¡—é“ç¤¾åŒºå«ç”ŸæœåŠ¡ä¸­å¿ƒ';
  document.getElementById('rDate').value = s.date;
  document.getElementById('rStatus').value = s.status;
  document.getElementById('rCode').value = s.code;

  let img = document.getElementById('reportCenterPreview');
  if (s.reportPhoto) {
    img.src = s.reportPhoto;
    img.style.display = 'block';
  } else {
    img.style.display = 'none';
  }
}

// ä½“æ£€æŠ¥å‘Šä¸­é—´ä¸Šä¼ 
function uploadReportCenter() {
  let file = document.getElementById('reportCenterUpload').files[0];
  if (!file) return;
  let reader = new FileReader();
  reader.onload = e => {
    let url = e.target.result;
    let img = document.getElementById('reportCenterPreview');
    img.src = url;
    img.style.display = 'block';

    let i = document.getElementById('reportSelect').value;
    if (i !== '') {
      staff[i].reportPhoto = url;
      localStorage.setItem('healthStaff', JSON.stringify(staff));
    }
  };
  reader.readAsDataURL(file);
}

function genCertLinkQR() {
  let i = document.getElementById('reportSelect').value;
  if (i === '') return alert('è¯·å…ˆé€‰æ‹©å‘˜å·¥');
  let s = staff[i];
  let url = window.location.origin + window.location.pathname + '?cert=' + encodeURIComponent(s.id);
  let box = document.getElementById('reportQRBox');
  box.innerHTML = '';
  reportQRCanvas = document.createElement('canvas');
  reportQRCanvas.width = 240;
  reportQRCanvas.height = 240;
  box.appendChild(reportQRCanvas);
  QRCode.toCanvas(reportQRCanvas, url, { width: 220, margin: 1 }, err => {
    if (err) alert('ç”Ÿæˆå¤±è´¥');
  });
  document.getElementById('downloadReportQRBtn').style.display = 'inline-block';
}

function downloadReportQR() {
  if (!reportQRCanvas) return alert('è¯·å…ˆç”ŸæˆäºŒç»´ç ');
  let link = document.createElement('a');
  link.download = 'å¥åº·è¯é“¾æ¥äºŒç»´ç .png';
  link.href = reportQRCanvas.toDataURL('image/png');
  link.click();
}

// ====================== äºŒç»´ç ç”Ÿæˆå™¨ ======================
function initQRStaffSelect() {
  let sel = document.getElementById('qrStaffSelect');
  sel.innerHTML = '<option value="">è¯·é€‰æ‹©å‘˜å·¥</option>';
  staff.forEach((s, i) => {
    sel.innerHTML += `<option value="${i}">${s.name} - ${s.code}</option>`;
  });
}

function genStaffCertQR() {
  let i = document.getElementById('qrStaffSelect').value;
  if (i === '') return alert('è¯·é€‰æ‹©å‘˜å·¥');
  let s = staff[i];
  let url = window.location.origin + window.location.pathname + '?cert=' + encodeURIComponent(s.id);
  genQR(url);
}

function genUploadCertQR() {
  let file = document.getElementById('certUpload').files[0];
  if (!file) return alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡');
  let reader = new FileReader();
  reader.onload = e => genQR(e.target.result);
  reader.readAsDataURL(file);
}

function genCustomQR() {
  let content = document.getElementById('qrContent').value.trim();
  if (!content) return alert('è¯·è¾“å…¥å†…å®¹');
  genQR(content);
}

function genQR(content) {
  let box = document.getElementById('qrBox');
  box.innerHTML = '';
  qrCanvas = document.createElement('canvas');
  qrCanvas.width = 260;
  qrCanvas.height = 260;
  box.appendChild(qrCanvas);
  QRCode.toCanvas(qrCanvas, content, { width: 240, margin: 1 }, err => {
    if (err) alert('ç”Ÿæˆå¤±è´¥');
  });
}

function downloadQR() {
  if (!qrCanvas) return alert('è¯·å…ˆç”ŸæˆäºŒç»´ç ');
  let link = document.createElement('a');
  link.download = 'äºŒç»´ç .png';
  link.href = qrCanvas.toDataURL('image/png');
  link.click();
}

// ====================== å‘˜å·¥ç¼–è¾‘ ======================
function openStaff() {
  curIdx = -1;
  curPhoto = '';
  document.getElementById('staffTitle').textContent = 'æ–°å¢å‘˜å·¥';
  document.getElementById('sName').value = '';
  document.getElementById('sGender').value = 'ç”·';
  document.getElementById('sAge').value = '';
  document.getElementById('sId').value = '';
  document.getElementById('sType').value = 'é¤é¥®æœåŠ¡';
  document.getElementById('sOrg').value = 'æ¸ä¸­åŒºä¸ƒæ˜Ÿå²—è¡—é“ç¤¾åŒºå«ç”ŸæœåŠ¡ä¸­å¿ƒ';
  document.getElementById('sDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('sStatus').value = 'æœ‰æ•ˆ';
  document.getElementById('sCode').value = 'TJ' + Date.now().toString().slice(-8);
  document.getElementById('photoPreview').innerHTML = 'ç‚¹å‡»ä¸Šä¼ ';
  document.getElementById('staffModal').style.display = 'flex';
}

function editStaff(i) {
  curIdx = i;
  let s = staff[i];
  curPhoto = s.photo || '';
  document.getElementById('staffTitle').textContent = 'ç¼–è¾‘å‘˜å·¥';
  document.getElementById('sName').value = s.name;
  document.getElementById('sGender').value = s.gender;
  document.getElementById('sAge').value = s.age;
  document.getElementById('sId').value = s.id;
  document.getElementById('sType').value = s.type;
  document.getElementById('sOrg').value = s.org || 'æ¸ä¸­åŒºä¸ƒæ˜Ÿå²—è¡—é“ç¤¾åŒºå«ç”ŸæœåŠ¡ä¸­å¿ƒ';
  document.getElementById('sDate').value = s.date;
  document.getElementById('sStatus').value = s.status;
  document.getElementById('sCode').value = s.code;
  document.getElementById('photoPreview').innerHTML = curPhoto ? `<img src="${curPhoto}" style="width:100%;height:100%;object-fit:cover;">` : 'ç‚¹å‡»ä¸Šä¼ ';
  document.getElementById('staffModal').style.display = 'flex';
}

function previewPhoto() {
  let file = document.getElementById('photoUpload').files[0];
  if (!file) return;
  let reader = new FileReader();
  reader.onload = e => {
    curPhoto = e.target.result;
    document.getElementById('photoPreview').innerHTML = `<img src="${curPhoto}" style="width:100%;height:100%;object-fit:cover;">`;
  };
  reader.readAsDataURL(file);
}

function saveStaff() {
  let data = {
    name: document.getElementById('sName').value,
    gender: document.getElementById('sGender').value,
    age: document.getElementById('sAge').value,
    id: document.getElementById('sId').value,
    type: document.getElementById('sType').value,
    org: document.getElementById('sOrg').value,
    date: document.getElementById('sDate').value,
    status: document.getElementById('sStatus').value,
    code: document.getElementById('sCode').value,
    photo: curPhoto,
    reportPhoto: ''
  };
  if (!data.name || !data.id) return alert('å§“åå’Œèº«ä»½è¯ä¸èƒ½ä¸ºç©º');
  if (curIdx >= 0) {
    data.reportPhoto = staff[curIdx].reportPhoto || '';
    staff[curIdx] = data;
  } else {
    staff.push(data);
  }
  localStorage.setItem('healthStaff', JSON.stringify(staff));
  closeModal();
  renderStaff();
  initCertSelect();
  initReportSelect();
  initQRStaffSelect();
}

function delStaff(i) {
  if (confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) {
    staff.splice(i, 1);
    localStorage.setItem('healthStaff', JSON.stringify(staff));
    renderStaff();
    initCertSelect();
    initReportSelect();
    initQRStaffSelect();
  }
}

function closeModal() {
  document.getElementById('staffModal').style.display = 'none';
}

function editReport() {
  let i = document.getElementById('reportSelect').value;
  if (i === '') return alert('è¯·é€‰æ‹©å‘˜å·¥');
  editStaff(i);
}

function exportStaff() {
  let data = [['å§“å','æ€§åˆ«','å²æ•°','èº«ä»½è¯å·','ç±»åˆ«','å‘è¯æœºæ„','ä½“æ£€æ—¥æœŸ','çŠ¶æ€','ä½“æ£€ç¼–ç ']];
  staff.forEach(s => {
    data.push([s.name,s.gender,s.age,s.id,s.type,s.org,s.date,s.status,s.code]);
  });
  let wb = XLSX.utils.book_new();
  let ws = XLSX.utils.aoa_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, 'å‘˜å·¥åˆ—è¡¨');
  XLSX.writeFile(wb, 'å‘˜å·¥åˆ—è¡¨.xlsx');
}

function importStaff() {
  let ipt = document.createElement('input');
  ipt.type = 'file';
  ipt.accept = '.xlsx';
  ipt.onchange = e => {
    let f = e.target.files[0];
    if (!f) return;
    let reader = new FileReader();
    reader.onload = e => {
      let wb = XLSX.read(e.target.result, { type: 'binary' });
      let ws = wb.Sheets[wb.SheetNames[0]];
      let arr = XLSX.utils.sheet_to_json(ws, { header: 1 });
      arr.shift();
      let list = [];
      arr.forEach(x => {
        if (x[0] && x[3]) {
          list.push({
            name: x[0], gender: x[1] || '', age: x[2] || '', id: x[3],
            type: x[4] || '', org: x[5] || 'æ¸ä¸­åŒºä¸ƒæ˜Ÿå²—è¡—é“ç¤¾åŒºå«ç”ŸæœåŠ¡ä¸­å¿ƒ',
            date: x[6] || '', status: x[7] || 'æœ‰æ•ˆ', code: x[8] || 'TJ' + Date.now().toString().slice(-8),
            photo: '', reportPhoto: ''
          });
        }
      });
      staff = list;
      localStorage.setItem('healthStaff', JSON.stringify(staff));
      renderStaff();
      initCertSelect();
      initReportSelect();
      initQRStaffSelect();
      alert('å¯¼å…¥æˆåŠŸ');
    };
    reader.readAsBinaryString(f);
  };
  ipt.click();
}
</script>
</body>
</html>
